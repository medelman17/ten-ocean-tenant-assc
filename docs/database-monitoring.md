# Database Monitoring & Backup Configuration\n\n**Project:** Ten Ocean Tenant Association Migration  \n**Database:** Neon PostgreSQL  \n**Created:** January 2025  \n\n## Overview\n\nThis document outlines the monitoring and backup strategy for the Ten Ocean Tenant Association database after migration from Supabase to Neon PostgreSQL.\n\n## ðŸ”§ Backup Strategy\n\n### 1. Neon Native Backup (Primary)\n\n**Configuration Location:** [Neon Console](https://console.neon.tech/app/projects/soft-waterfall-46034922)\n\n**Recommended Settings:**\n- **Frequency:** Daily backups\n- **Schedule:** 2:00 AM UTC (low usage period)\n- **Retention:** 14 days minimum\n- **Point-in-Time Recovery:** Enable WAL archiving\n- **Storage:** Encrypted cloud storage\n\n**Steps to Configure:**\n1. Navigate to Neon Dashboard â†’ Your Project\n2. Go to Settings â†’ Backup/Recovery section\n3. Enable automated backups\n4. Set retention period to 14 days\n5. Configure backup notifications\n\n### 2. GitHub Actions Backup (Fallback)\n\n**File:** `.github/workflows/database-backup.yml`\n\n**Features:**\n- Daily automated backups using `pg_dump`\n- Secure S3 storage with encryption\n- 30-day retention policy\n- Slack notifications on failure\n- Manual trigger capability\n\n**Required Secrets:**\n```bash\n# GitHub Repository Secrets\nDATABASE_URL=postgres://neondb_owner:password@host/db\nAWS_ACCESS_KEY_ID=your_aws_key\nAWS_SECRET_ACCESS_KEY=your_aws_secret\nBACKUP_S3_BUCKET=your-backup-bucket\nSLACK_WEBHOOK_URL=your_slack_webhook\n```\n\n**Manual Backup Command:**\n```bash\n# For immediate backup\npg_dump $DATABASE_URL --clean --if-exists --format=plain > backup_$(date +%Y%m%d).sql\n```\n\n## ðŸ“Š Monitoring Setup\n\n### Key Metrics to Track\n\n| Metric Category | Specific Metrics | Alert Threshold | Impact |\n|-----------------|------------------|-----------------|--------|\n| **Connections** | Active connections | >80% of limit | High |\n| **Performance** | Query latency | >2 seconds avg | Medium |\n| **Storage** | Database size | >85% of quota | High |\n| **Errors** | Connection failures | >5% error rate | High |\n| **Backup** | Backup success | Any failure | Critical |\n| **Replication** | WAL lag | >1GB behind | Medium |\n\n### 1. Neon Native Monitoring\n\n**Dashboard Access:** Neon Console â†’ Monitoring\n\n**Key Features:**\n- Real-time connection monitoring\n- Query performance metrics\n- Storage usage tracking\n- Error rate monitoring\n\n**Alert Configuration:**\n1. Navigate to Monitoring â†’ Alerts\n2. Set up alerts for:\n   - Connection pool utilization >80%\n   - Storage usage >85%\n   - Query latency >2 seconds\n   - Error rate >5%\n\n### 2. Application-Level Monitoring\n\n**Prisma Metrics:**\n```typescript\n// Example monitoring integration\nimport { PrismaClient } from '@prisma/client'\n\nconst prisma = new PrismaClient({\n  log: [\n    { emit: 'event', level: 'query' },\n    { emit: 'event', level: 'error' },\n    { emit: 'event', level: 'info' },\n    { emit: 'event', level: 'warn' },\n  ],\n})\n\n// Log slow queries\nprisma.$on('query', (e) => {\n  if (e.duration > 2000) {\n    console.warn(`Slow query detected: ${e.duration}ms`, e.query)\n  }\n})\n```\n\n**Health Check Endpoint:**\n```typescript\n// /api/health/database\nexport async function GET() {\n  try {\n    await prisma.$queryRaw`SELECT 1`\n    return Response.json({ status: 'healthy', timestamp: new Date() })\n  } catch (error) {\n    return Response.json(\n      { status: 'unhealthy', error: error.message },\n      { status: 500 }\n    )\n  }\n}\n```\n\n### 3. External Monitoring Tools\n\n**Recommended Integrations:**\n- **Datadog:** Full APM with PostgreSQL integration\n- **New Relic:** Database performance monitoring\n- **Prometheus + Grafana:** Custom metrics dashboard\n- **UptimeRobot:** Uptime monitoring\n\n## ðŸš¨ Alerting Configuration\n\n### Critical Alerts (Immediate Response)\n\n1. **Database Unavailable**\n   - **Trigger:** Connection failures >90%\n   - **Notification:** SMS + Email + Slack\n   - **Response Time:** <5 minutes\n\n2. **Backup Failure**\n   - **Trigger:** Backup job fails\n   - **Notification:** Email + Slack\n   - **Response Time:** <30 minutes\n\n3. **Storage Critical**\n   - **Trigger:** >95% storage used\n   - **Notification:** SMS + Email\n   - **Response Time:** <15 minutes\n\n### Warning Alerts (Monitor & Plan)\n\n1. **Performance Degradation**\n   - **Trigger:** Avg query time >1 second\n   - **Notification:** Email + Slack\n   - **Response Time:** <2 hours\n\n2. **Connection Pool Stress**\n   - **Trigger:** >70% connections used\n   - **Notification:** Slack\n   - **Response Time:** <4 hours\n\n## ðŸ” Monitoring Dashboard\n\n### Essential Widgets\n\n1. **Connection Status**\n   - Active connections vs. limit\n   - Connection success/failure rate\n   - Pool utilization over time\n\n2. **Performance Metrics**\n   - Query latency (p50, p95, p99)\n   - Slow query count\n   - Transactions per second\n\n3. **Resource Usage**\n   - Database size growth\n   - Storage utilization percentage\n   - WAL segment usage\n\n4. **Backup Status**\n   - Last successful backup timestamp\n   - Backup size trend\n   - Recovery point objective (RPO)\n\n## ðŸ§ª Testing & Validation\n\n### Backup Testing\n\n```bash\n# Test backup restoration (staging environment)\n# 1. Create test backup\npg_dump $DATABASE_URL > test_backup.sql\n\n# 2. Restore to staging database\npsql $STAGING_DATABASE_URL < test_backup.sql\n\n# 3. Verify data integrity\npsql $STAGING_DATABASE_URL -c \"SELECT COUNT(*) FROM user_profiles;\"\n```\n\n### Monitoring Testing\n\n```bash\n# Test alert triggers\n# 1. Simulate high connection load\n# 2. Create slow queries\n# 3. Fill storage (staging)\n# 4. Verify alert notifications\n```\n\n### Point-in-Time Recovery Testing\n\n```bash\n# Test PITR (Point-in-Time Recovery)\n# 1. Note current timestamp\n# 2. Make known changes\n# 3. Restore to timestamp before changes\n# 4. Verify changes are reverted\n```\n\n## ðŸ“ˆ Performance Baselines\n\n### Expected Performance (Production)\n\n- **Connection Time:** <100ms\n- **Query Latency (p95):** <500ms\n- **Backup Duration:** <30 minutes\n- **Storage Growth:** <10GB/month\n- **Uptime Target:** 99.9%\n\n### Resource Limits\n\n- **Max Connections:** 100 (with pooling)\n- **Storage Quota:** 10GB (Neon plan)\n- **WAL Retention:** 7 days\n- **Backup Retention:** 30 days\n\n## ðŸ”„ Maintenance Schedule\n\n### Daily\n- âœ… Verify backup completion\n- âœ… Check monitoring alerts\n- âœ… Review slow query log\n\n### Weekly\n- âœ… Analyze performance trends\n- âœ… Review storage usage\n- âœ… Test backup restoration\n\n### Monthly\n- âœ… Update monitoring thresholds\n- âœ… Review alert effectiveness\n- âœ… Performance optimization review\n- âœ… Security audit\n\n## ðŸ“ž Emergency Contacts\n\n### Escalation Path\n\n1. **Primary:** Development Team Lead\n2. **Secondary:** Database Administrator\n3. **Tertiary:** Neon Support\n\n### Support Channels\n\n- **Neon Support:** [support@neon.tech](mailto:support@neon.tech)\n- **Slack Channel:** #database-alerts\n- **Emergency Phone:** [Emergency contact number]\n\n---\n\n**Last Updated:** January 2025  \n**Review Date:** March 2025  \n**Document Owner:** Database Team" 